<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emissão de Apólice</title>
    
    <script src="js/config.js"></script>

    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' blob: data: gap:; style-src * 'self' 'unsafe-inline' blob: data: gap:; script-src * 'self' 'unsafe-eval' 'unsafe-inline' blob: data: gap:; connect-src * 'unsafe-inline' blob: data: gap:;">
    
    <link rel="icon" href="assets/logo.png" type="image/png">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/masks.js"></script> 

    <style>
        .loading { color: #666; font-style: italic; }
        .btn-processar { background-color: #2e7d32; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-processar:hover { background-color: #1b5e20; }
        .btn-salvar { width: 100%; margin-top: 20px; padding: 15px; background-color: #1976d2; color: white; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .btn-salvar:hover { background-color: #1565c0; }
        .upload-container { background-color: #e3f2fd; border: 2px dashed #1976d2; padding: 20px; border-radius: 8px; margin-top: 15px; text-align: center; }
        #status-pdf { font-weight: bold; margin-top: 10px; min-height: 20px; }
    </style>
</head>
<body class="dashboard-body">

    <header class="app-header">
        <div class="header-brand"><a href="dashboard.html"><img src="assets/logo.png" alt="Logo" class="header-logo"></a></div>
        <nav class="header-nav">
            <a href="dashboard.html" class="header-link">DASHBOARD</a>
            <a href="apolice.html" class="header-link active">APÓLICES</a>
            <a href="registro.html?origin=dashboard" class="header-link">USUÁRIOS</a>
            <a href="relatorios.html" class="header-link">RELATÓRIOS</a>
        </nav>
        <div class="header-user-area">
            <div class="user-info"><span class="user-name">Olá, <strong id="user-name-display">...</strong></span></div>
            <button id="btn-logout" class="btn-logout-panel">SAIR</button>
        </div>
    </header>

    <div class="main-container">
        <div style="margin-bottom: 20px; border-left: 5px solid #2e7d32; padding-left: 15px;">
            <h2 style="color: #444; margin:0;" id="titulo-pagina">Emissão de Apólice</h2>
            <p style="color: #666; margin: 5px 0 0 0; font-size: 14px;">Preencha os dados abaixo ou importe via PDF.</p>
        </div>

        <div class="upload-container">
            <p style="font-size:15px; color:#333; margin-bottom:10px;"><b>Passo 1:</b> Selecione o PDF da apólice (Opcional na edição)</p>
            <input type="file" id="pdf_upload" name="arquivo_pdf" accept="application/pdf" style="margin-bottom: 10px;">
            <br>
            <button type="button" id="btn-ler-pdf" class="btn-processar"><i class="fas fa-magic"></i> Ler Dados do PDF</button>
            <p id="status-pdf"></p>
        </div>

        <div class="card" id="painel-apolice" style="margin-top: 20px;">
            <h3 style="margin:0 0 20px 0; color:#2e7d32; border-bottom: 1px solid #eee; padding-bottom: 10px;">Passo 2: Conferir Dados</h3>
            
            <label style="font-weight:bold;">Veículo / Cliente *</label>
            <select id="veiculo_id" style="width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px; background: #fff;">
                <option value="">Carregando lista...</option>
            </select>

            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                <div style="flex: 1;"><label>Nº Apólice</label><input type="text" id="numero_apolice" class="campo-dado" style="width: 100%; padding: 10px;"></div>
                <div style="flex: 1;"><label>Nº Proposta</label><input type="text" id="numero_proposta" class="campo-dado" style="width: 100%; padding: 10px;"></div>
            </div>

            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <div style="flex: 1;"><label>Início Vigência</label><input type="date" id="vigencia_inicio" class="campo-dado" style="width: 100%; padding: 10px;"></div>
                <div style="flex: 1;"><label>Fim Vigência</label><input type="date" id="vigencia_fim" class="campo-dado" style="width: 100%; padding: 10px;"></div>
            </div>

            <h4 style="margin: 0 0 10px 0; color: #555;">Valores Financeiros</h4>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 120px;">
                    <label>Prêmio Líquido</label>
                    <input type="text" id="premio_liquido" class="form-control mask-dinheiro" placeholder="R$ 0,00">
                </div>
                <div style="flex: 1; min-width: 120px;">
                    <label style="color: #2e7d32; font-weight: bold;">Prêmio Total</label>                                
                    <input type="text" id="premio_total" class="form-control mask-dinheiro" placeholder="R$ 0,00">
                </div>
                <div style="flex: 1; min-width: 120px;">
                    <label>Franquia</label>
                   <input type="text" id="franquia_casco" class="form-control mask-dinheiro" placeholder="R$ 0,00">
                </div>
                
                <div style="flex: 0 0 100px;"> 
                    <label style="color: #1976d2; font-weight: bold; font-size:12px;">% Usada</label>
                    <input type="number" id="porcentagem_comissao" class="form-control" placeholder="%" step="0.1" value="15">
                </div>
                <div style="flex: 1; min-width: 100px;">
                    <label style="color: #1976d2; font-weight: bold;">Valor Repasse (R$)</label>
                    <input type="text" id="valor_repasse" class="form-control" placeholder="0,00">
                </div>
                <div style="flex: 1; min-width: 120px;">
                    <label style="color: #1976d2; font-weight: bold;">Comissão Recebida (R$)</label>
                    <input type="text" id="valor_comissao" class="form-control mask-dinheiro" placeholder="R$ 0,00" readonly style="background-color: #f9f9f9; font-weight:bold;">
                </div>
            </div>

            <button type="button" id="btn-acao-salvar" class="btn-salvar"><i class="fas fa-save"></i> SALVAR APÓLICE</button>
        </div>
        
        <div style="text-align:center; margin-top:20px; color:#999; font-size:12px;">ASL TECH SYSTEM</div>
    </div>

    <script>
    (function() {
        // Configuração Inicial
        const BASE_URL = (typeof API_URL !== 'undefined') ? API_URL : 'https://seguradoraproject.onrender.com';
        const localToken = localStorage.getItem('token');
        const urlParams = new URLSearchParams(window.location.search);
        const idEdicao = urlParams.get('id');

        if (!localToken) { window.location.href = 'index.html'; return; }

        const nome = localStorage.getItem('usuario_logado');
        if (document.getElementById('user-name-display') && nome) 
            document.getElementById('user-name-display').innerText = nome.split(' ')[0];

        // --- CONVERSÃO INTELIGENTE ---
        function converterParaFloat(valor) {
            if (!valor) return 0;
            let str = valor.toString();
            if (str.includes(',') && str.includes('.')) return parseFloat(str.replace(/\./g, '').replace(',', '.'));
            if (str.includes(',')) return parseFloat(str.replace(/\./g, '').replace(',', '.'));
            return parseFloat(str);
        }

        // --- CÁLCULO BLINDADO ---
        function calcularComissao() {
            let liquidoStr = document.getElementById('premio_liquido').value || '0';
            const totalStr = document.getElementById('premio_total').value || '0'; 
            const porcStr = document.getElementById('porcentagem_comissao').value || '0';
            const repasseStr = document.getElementById('valor_repasse').value || '0';
            
            let liquido = converterParaFloat(liquidoStr);
            let total = converterParaFloat(totalStr);
            const porcentagem = parseFloat(porcStr);
            const repasse = converterParaFloat(repasseStr);

            if (liquido === 0 && total > 0) liquido = total;

            const valLiquido = isNaN(liquido) ? 0 : liquido;
            const valPorc = isNaN(porcentagem) ? 0 : porcentagem;
            const valRepasse = isNaN(repasse) ? 0 : repasse;

            const comissaoPorcentagem = valLiquido * (valPorc / 100);
            const comissaoFinal = comissaoPorcentagem + valRepasse;

            document.getElementById('valor_comissao').value = comissaoFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Listeners para cálculo automático
        ['premio_liquido', 'premio_total', 'porcentagem_comissao', 'valor_repasse'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('input', calcularComissao);
                el.addEventListener('blur', calcularComissao);
            }
        });

        function setValor(id, valor) {
            const el = document.getElementById(id);
            if(el && valor !== undefined && valor !== null) el.value = valor;
        }

        // --- IMPORTAR PDF ---
        document.getElementById('btn-ler-pdf').addEventListener('click', async (e) => {
            e.preventDefault(); 
            const fileInput = document.getElementById('pdf_upload');
            const statusMsg = document.getElementById('status-pdf');

            if (fileInput.files.length === 0) return Swal.fire('Atenção', 'Selecione o arquivo PDF primeiro.', 'warning');
            statusMsg.innerText = "Processando...";
            const fd = new FormData();
            fd.append('arquivoPdf', fileInput.files[0]);

            try {
                const res = await fetch(`${BASE_URL}/importar-pdf`, { 
                    method: 'POST', 
                    headers: { 'Authorization': `Bearer ${localToken}` },
                    body: fd 
                });
                const json = await res.json();
                const d = json.dados;
                
                setValor('numero_apolice', d.numero_apolice);
                setValor('numero_proposta', d.numero_proposta);
                setValor('vigencia_inicio', d.vigencia_inicio);
                setValor('vigencia_fim', d.vigencia_fim);
                setValor('premio_total', d.premio_total);
                setValor('premio_liquido', d.premio_liquido);
                setValor('franquia_casco', d.franquia_casco);
                
                if (!d.premio_liquido && d.premio_total) setValor('premio_liquido', d.premio_total);

                setValor('valor_repasse', '0,00'); 
                setValor('porcentagem_comissao', 15);
                calcularComissao();

                statusMsg.innerText = "Lido com sucesso!";
                statusMsg.style.color = "green";

                if (d.placa) {
                    const sel = document.getElementById('veiculo_id');
                    const busca = d.placa.toUpperCase().replace(/[^A-Z0-9]/g, '');
                    for(let i=0; i<sel.options.length; i++) {
                        if(sel.options[i].text.replace(/[^A-Z0-9]/g, '').includes(busca)) {
                            sel.selectedIndex = i; break;
                        }
                    }
                }
            } catch(err) {
                console.error(err);
                statusMsg.innerText = "Erro ao ler.";
                Swal.fire('Erro', 'Falha na leitura do PDF.', 'error');
            }
        });

        // --- SALVAR / ATUALIZAR ---
        document.getElementById('btn-acao-salvar').addEventListener('click', async (e) => {
            e.preventDefault();
            const veiculo = document.getElementById('veiculo_id').value;
            if (!veiculo) return Swal.fire('Erro', 'Selecione o Cliente/Veículo!', 'error');
            
            const fileInput = document.getElementById('pdf_upload');
            // Se for criação e não tiver PDF, avisa. Se for edição, PDF é opcional.
            if (!idEdicao && fileInput.files.length === 0) return Swal.fire('Atenção', 'Selecione o PDF.', 'warning');

            const formData = new FormData();
            formData.append('veiculo_id', veiculo);
            formData.append('numero_apolice', document.getElementById('numero_apolice').value || '');
            formData.append('numero_proposta', document.getElementById('numero_proposta').value || '');
            formData.append('vigencia_inicio', document.getElementById('vigencia_inicio').value || '');
            formData.append('vigencia_fim', document.getElementById('vigencia_fim').value || '');
            
            formData.append('premio_liquido', document.getElementById('premio_liquido').value || '0.00');
            formData.append('premio_total', document.getElementById('premio_total').value || '0.00');
            formData.append('franquia_casco', document.getElementById('franquia_casco').value || '0.00');
            formData.append('valor_comissao', document.getElementById('valor_comissao').value || '0.00');
            formData.append('valor_repasse', document.getElementById('valor_repasse').value || '0.00');

            if (fileInput.files.length > 0) formData.append('arquivo_pdf', fileInput.files[0]);

            const endpoint = idEdicao ? `${BASE_URL}/apolices/${idEdicao}` : `${BASE_URL}/cadastrar-apolice`;
            const method = idEdicao ? 'PUT' : 'POST';

            try {
                Swal.fire({ title: 'Salvando...', didOpen: () => Swal.showLoading() });
                const res = await fetch(endpoint, { method: method, headers: { 'Authorization': `Bearer ${localToken}` }, body: formData });
                const json = await res.json();

                if (res.ok) {
                    // Mensagem personalizada baseada no contexto
                    const msgSucesso = idEdicao ? 'Dados Atualizados e salvo!' : 'Apólice Criada com Sucesso!';
                    await Swal.fire('Sucesso!', msgSucesso, 'success');
                    window.location.href = 'dashboard.html';
                } else { Swal.fire('Erro', json.message || 'Erro ao salvar.', 'error'); }
            } catch(err) { Swal.fire('Erro', 'Falha de conexão.', 'error'); }
        });

        // --- CARREGAMENTO INICIAL DE DADOS ---
        (async () => {
            // Se estiver editando, mostra Loading IMEDIATAMENTE
            if (idEdicao) {
                Swal.fire({
                    title: 'Carregando...',
                    text: 'Buscando dados da apólice',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });
                document.getElementById('titulo-pagina').innerText = "Editar Apólice";
                document.getElementById('btn-acao-salvar').innerText = "ATUALIZAR DADOS";
            }

            try {
                // 1. Carrega lista de veículos
                const res = await fetch(`${BASE_URL}/propostas`, { headers: { 'Authorization': `Bearer ${localToken}` } });
                const list = await res.json();
                const sel = document.getElementById('veiculo_id');
                sel.innerHTML = '<option value="">Selecione...</option>';
                list.forEach(i => {
                    const opt = document.createElement('option');
                    opt.value = i.id;
                    opt.text = `${i.nome} | ${i.placa}`;
                    sel.appendChild(opt);
                });

                // 2. Se for edição, carrega dados da apólice
                if(idEdicao) {
                    const resApolice = await fetch(`${BASE_URL}/apolices/${idEdicao}`, { headers: { 'Authorization': `Bearer ${localToken}` } });
                    if(!resApolice.ok) throw new Error("Erro ao buscar apólice");
                    
                    const d = await resApolice.json();
                    
                    setValor('veiculo_id', d.veiculo_id);
                    setValor('numero_apolice', d.numero_apolice);
                    setValor('numero_proposta', d.numero_proposta);
                    setValor('premio_total', d.premio_total);
                    setValor('premio_liquido', d.premio_liquido);
                    setValor('franquia_casco', d.franquia_casco);
                    setValor('valor_comissao', d.valor_comissao);
                    setValor('valor_repasse', d.valor_repasse);

                    if(d.vigencia_inicio) setValor('vigencia_inicio', d.vigencia_inicio.split('T')[0]);
                    if(d.vigencia_fim) setValor('vigencia_fim', d.vigencia_fim.split('T')[0]);

                    // Recalcula % visual
                    let liq = converterParaFloat(d.premio_liquido);
                    let comTotal = converterParaFloat(d.valor_comissao);
                    let rep = converterParaFloat(d.valor_repasse || '0');

                    if(liq > 0 && comTotal > 0) {
                        let comissaoBase = comTotal - rep;
                        let perc = (comissaoBase / liq) * 100;
                        setValor('porcentagem_comissao', Math.round(perc * 10) / 10);
                    } else {
                        setValor('porcentagem_comissao', 15);
                    }
                    
                    Swal.close(); // Fecha o loading quando tudo estiver preenchido
                }
            } catch(e) {
                console.error(e);
                if(idEdicao) Swal.fire('Erro', 'Falha ao carregar dados da edição.', 'error');
            }
        })();

        document.getElementById('btn-logout').addEventListener('click', () => { localStorage.clear(); window.location.href = 'index.html'; });
    })();
    </script>
</body>
</html>