<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="js/config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Usu√°rio</title>
    
    <meta http-equiv="Content-Security-Policy" 
    content="default-src * 'self' blob: data: gap:; 
    style-src * 'self' 'unsafe-inline' blob: data: gap:; 
    script-src * 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net blob: data: gap:; 
    connect-src 'self' http://localhost:10000 http://localhost:3000 https://apolicesystem.onrender.com * 'unsafe-inline' blob: data: gap:;">
    
    <link rel="icon" href="assets/logo.png" type="image/png">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="dashboard-body">

    <header class="app-header">
        <div class="header-brand"><a href="dashboard.html"><img src="assets/logo.png" alt="Logo" class="header-logo"></a></div>
        <nav class="header-nav">
            <a href="dashboard.html" class="header-link">DASHBOARD</a>
            <a href="apolice.html" class="header-link">AP√ìLICES</a>
            <a href="registro.html" class="header-link active">USU√ÅRIOS</a>
            <a href="relatorios.html" class="header-link">RELAT√ìRIOS</a>
        </nav>
        <div class="header-user-area">
            <div class="user-info"><span class="user-name">Ol√°, <strong id="user-name-display">...</strong></span></div>
            <button id="btn-logout" class="btn-logout-panel">SAIR</button>
        </div>
    </header>

    <div class="main-container">
        <div style="margin-bottom: 20px;">
            <a href="dashboard.html" style="text-decoration: none; color: #666; font-size: 13px;">
                <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
            </a>
        </div>

        <div class="card" style="max-width: 600px; margin: 0 auto; border-top: 4px solid #7b1fa2;">
            <h3 id="titulo-pagina" style="color: #7b1fa2; margin-bottom: 25px;">
                <i class="fas fa-user-plus"></i> Novo Usu√°rio do Sistema
            </h3>

            <form id="form-registro">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Nome Completo</label>
                    <input type="text" id="nome" placeholder="Ex: Jo√£o Silva" required>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label>E-mail Corporativo</label>
                    <input type="email" id="email" placeholder="Ex: joao@seguradora.com" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Senha de Acesso</label>
                        <input type="password" id="senha" placeholder="******">
                        <small id="dica-senha" style="color:#666; display:none;">Deixe em branco para manter a senha atual.</small>
                    </div>
                    <div class="form-group">
                        <label>Perfil de Acesso</label>
                        <select id="tipo">
                            <option value="padrao">Padr√£o B√°sico</option>
                            <option value="admin">Administrador</option>
                            <option value="ti">Suporte</option> 
                        </select>
                    </div>
                </div>

                <button type="submit" id="btn-salvar" class="btn-novo" style="background-color: #7b1fa2; margin-top: 20px;">
                    CADASTRAR USU√ÅRIO
                </button>
            </form>
        </div>
        <div class="system-credits" style="text-align: center;">By √Åidano Lima - ASL TECH</div>
    </div>

    <script>
        // Configura√ß√£o de API (Local vs Produ√ß√£o)
        const BASE_API = (typeof API_URL !== 'undefined') ? API_URL : 'https://seguradoraproject.onrender.com';
        
        const token = localStorage.getItem('token');
        const tipoUsuarioLogado = localStorage.getItem('tipo_usuario'); // Recupera o tipo de usu√°rio
        
        // Verifica se tem ID na URL (Modo Edi√ß√£o)
        const urlParams = new URLSearchParams(window.location.search);
        const idEdicao = urlParams.get('id');

        // Inicializa√ß√£o
        if (!token) window.location.href = 'index.html';

        // ==================================================
        // üîí TRAVA DE SEGURAN√áA (CR√çTICO)
        // ==================================================
        // Define quem √© MASTER (Admin ou TI)
        const isMaster = (tipoUsuarioLogado === 'admin' || tipoUsuarioLogado === 'ti');

        // Se N√ÉO √© Master E N√ÉO tem ID na URL (tentativa de criar novo) -> BLOQUEIA
        if (!isMaster && !idEdicao) {
            Swal.fire({
                icon: 'warning',
                title: 'Acesso Restrito',
                text: 'Seu perfil permite apenas editar seus pr√≥prios dados.',
                confirmButtonColor: '#7b1fa2',
                confirmButtonText: 'Voltar ao Painel',
                allowOutsideClick: false
            }).then(() => {
                window.location.href = 'dashboard.html';
            });
            // Para a execu√ß√£o do script aqui para n√£o carregar o resto
            throw new Error("Acesso negado: Usu√°rio padr√£o tentou criar novo registro.");
        }
        // ==================================================
        
        const nomeLogado = localStorage.getItem('usuario_logado');
        if(document.getElementById('user-name-display') && nomeLogado) 
            document.getElementById('user-name-display').innerText = nomeLogado.split(' ')[0];

        document.getElementById('btn-logout').addEventListener('click', () => {
            localStorage.clear(); window.location.href = 'index.html';
        });

        // --- L√ìGICA DE SEGURAN√áA NO FRONT-END (DROPDOWN) ---
        // Se N√ÉO for Master (Admin/TI), for√ßa o campo a ter apenas a op√ß√£o 'padrao'
        if (!isMaster) {
            const selectTipo = document.getElementById('tipo');
            selectTipo.innerHTML = '<option value="padrao">Padr√£o (Visualizar)</option>';
            selectTipo.disabled = true; // Visualmente travado
        }

        // --- L√ìGICA DE EDI√á√ÉO ---
        if (idEdicao) {
            prepararModoEdicao();
        }

        async function prepararModoEdicao() {
            // 1. Ajustar Visual
            document.getElementById('titulo-pagina').innerHTML = '<i class="fas fa-user-edit"></i> Editar Usu√°rio';
            document.getElementById('btn-salvar').innerText = "SALVAR ALTERA√á√ïES";
            document.getElementById('senha').required = false; // Senha opcional na edi√ß√£o
            document.getElementById('senha').placeholder = "(N√£o alterada)";
            document.getElementById('dica-senha').style.display = 'block';

            // 2. Carregar Dados
            try {
                const res = await fetch(`${BASE_API}/usuarios/${idEdicao}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(!res.ok) throw new Error("Erro ao buscar usu√°rio");
                
                const user = await res.json();
                
                document.getElementById('nome').value = user.nome;
                document.getElementById('email').value = user.email;
                
                // Se for Master (Admin/TI), carrega o valor real. 
                // Se n√£o for, j√° travamos como 'padrao' acima.
                if (isMaster) {
                    document.getElementById('tipo').value = user.tipo;
                }

            } catch (error) {
                console.error(error);
                Swal.fire('Erro', 'N√£o foi poss√≠vel carregar os dados.', 'error');
            }
        }

        // --- SALVAR (CRIAR OU ATUALIZAR) ---
        document.getElementById('form-registro').addEventListener('submit', async (e) => {
            e.preventDefault();

            const dados = {
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                senha: document.getElementById('senha').value,
                tipo: document.getElementById('tipo').value
            };

            // Define URL e M√©todo baseado no modo (Edi√ß√£o ou Cria√ß√£o)
            const endpoint = idEdicao ? `${BASE_API}/usuarios/${idEdicao}` : `${BASE_API}/registrar`;
            const method = idEdicao ? 'PUT' : 'POST';

            try {
                Swal.fire({ title: 'Salvando...', didOpen: () => Swal.showLoading() });
                
                const res = await fetch(endpoint, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dados)
                });

                if (res.ok) {
                    await Swal.fire('Sucesso!', idEdicao ? 'Dados atualizados.' : 'Usu√°rio cadastrado.', 'success');
                    window.location.href = 'dashboard.html';
                } else {
                    const err = await res.json();
                    throw new Error(err.message);
                }
            } catch (error) {
                Swal.fire('Erro', error.message, 'error');
            }
        });
    </script>

</body>
</html>